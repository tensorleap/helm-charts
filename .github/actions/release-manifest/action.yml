name: Release Manifest
description: Release installation manifest (reusable for both candidate and production)

inputs:
  github_token:
    description: 'GitHub token for authentication'
    required: true
  custom_tag_prefix:
    description: 'Custom tag prefix for manifest'
    required: false
    default: ''
  manifest_output:
    description: 'Output filename for manifest'
    required: false
    default: 'manifest.yaml'
  branch:
    description: 'Branch to checkout (if not provided, uses github.ref)'
    required: false
    default: ''

runs:
  using: composite
  steps:
    - name: Determine checkout ref
      id: checkout_ref
      run: |
        if [ -n "${{ inputs.branch }}" ]; then
          echo "ref=${{ inputs.branch }}" >> $GITHUB_OUTPUT
        else
          echo "ref=${{ github.ref }}" >> $GITHUB_OUTPUT
        fi
      shell: bash

    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ inputs.github_token }}
        ref: ${{ steps.checkout_ref.outputs.ref }}
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version-file: ./go.mod

    - name: Get tensorleap chart version
      id: get_tensorleap_chart_version
      run: |
        CHART_VERSION=$(cat charts/tensorleap/Chart.yaml | grep -E '^version:' | awk '{print $2}')
        echo "version=$CHART_VERSION" >> $GITHUB_OUTPUT
      shell: bash

    - name: Get tensorleap infra chart version
      id: get_tensorleap_infra_chart_version
      run: |
        INFRA_CHART_VERSION=$(cat charts/tensorleap-infra/Chart.yaml | grep -E '^version:' | awk '{print $2}')
        echo "version=$INFRA_CHART_VERSION" >> $GITHUB_OUTPUT
      shell: bash

    - name: Set manifest version
      id: set_manifest_version
      run: |

        # Use the full chart version as-is (includes RC suffix if present, e.g., 1.4.34-rc.0)
        # Default prefix: 'manifest' if called from release_production.yml, otherwise empty string
        if [ -z "${{ inputs.custom_tag_prefix }}" ]; then
          if [ "${{ github.workflow }}" == "Release Version To Production" ]; then
            DEFAULT_PREFIX="manifest"
          else
            DEFAULT_PREFIX=""
          fi
          PREFIX="$DEFAULT_PREFIX"
        else
          PREFIX="${{ inputs.custom_tag_prefix }}"
        fi
        # Set the manifest version to the tensorleap chart version
        if [ -n "$PREFIX" ]; then
          TAG="${PREFIX}-${{ steps.get_tensorleap_chart_version.outputs.version }}"
        else
          TAG="${{ steps.get_tensorleap_chart_version.outputs.version }}"
        fi
        echo "tag=$TAG" >> $GITHUB_OUTPUT

        # Only mark as latest if tag starts with "manifest-"
        if [[ "$TAG" == manifest-* ]]; then
          echo "prerelease=false" >> $GITHUB_OUTPUT
        else
          echo "prerelease=true" >> $GITHUB_OUTPUT
        fi
      shell: bash

    - name: Create installation manifest
      run: |
        echo "ğŸ“¦ Tensorleap chart version: ${{ steps.get_tensorleap_chart_version.outputs.version }}"
        echo "ğŸ“¦ Tensorleap infra chart version: ${{ steps.get_tensorleap_infra_chart_version.outputs.version }}"
        echo "ğŸ·ï¸  Release tag: ${{ steps.set_manifest_version.outputs.tag }}"
        # Use --local flag when branch is provided (files are already checked out)
        if [ -n "${{ inputs.branch }}" ]; then
          go run . create-manifest --local --tensorleap-chart-version ${{ steps.get_tensorleap_chart_version.outputs.version  }} --tensorleap-infra-chart-version ${{ steps.get_tensorleap_infra_chart_version.outputs.version }} --tag ${{ steps.set_manifest_version.outputs.tag }} --output manifest.yaml
        else
          go run . create-manifest --tensorleap-chart-version ${{ steps.get_tensorleap_chart_version.outputs.version  }} --tensorleap-infra-chart-version ${{ steps.get_tensorleap_infra_chart_version.outputs.version }} --tag ${{ steps.set_manifest_version.outputs.tag }} --output manifest.yaml
        fi
      shell: bash

    - name: Print charts versions
      run: |
        echo "Tensorleap chart version: ${{ steps.get_tensorleap_chart_version.outputs.version }}"
        echo "Tensorleap infra chart version: ${{ steps.get_tensorleap_infra_chart_version.outputs.version }}"
      shell: bash

    - name: Print manifest
      run: cat manifest.yaml
      shell: bash

    - name: Create GitHub release
      uses: ncipollo/release-action@v1
      with:
        artifacts: manifest.yaml
        tag: "${{ steps.set_manifest_version.outputs.tag }}"
        prerelease: ${{ steps.set_manifest_version.outputs.prerelease }}
        skipIfReleaseExists: true
        generateReleaseNotes: true
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
