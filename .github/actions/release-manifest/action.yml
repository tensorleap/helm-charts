name: Release Manifest
description: Release installation manifest (reusable for both candidate and production)

inputs:
  github_token:
    description: 'GitHub token for authentication'
    required: true
  custom_tag_prefix:
    description: 'Custom tag prefix for manifest'
    required: false
    default: ''
  manifest_output:
    description: 'Output filename for manifest'
    required: false
    default: 'manifest.yaml'
  branch:
    description: 'Branch to checkout'
    required: false
    default: ''

runs:
  using: composite
  steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ inputs.github_token }}
        ref: ${{ inputs.branch || github.ref }}
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version-file: ./go.mod

    - name: Determine release prefix and type
      id: determine_release_type
      run: |
          # Use custom_tag_prefix if provided, otherwise empty string
          if [ -n "${{ inputs.custom_tag_prefix }}" ]; then
            PREFIX="${{ inputs.custom_tag_prefix }}"
        else
          PREFIX=""
        fi
        
        echo "prefix=$PREFIX" >> $GITHUB_OUTPUT
      shell: bash

    - name: Get tensorleap chart version
      id: get_tensorleap_chart_version
      run: |
        # - For RC releases: Chart.yaml has RC suffix (updated by checkout-rc-branch)
        # - For production: Chart.yaml has RC suffix removed (updated by release_production.yml)
        CHART_VERSION=$(cat charts/tensorleap/Chart.yaml | grep -E '^version:' | awk '{print $2}')
        echo "version=$CHART_VERSION" >> $GITHUB_OUTPUT
      shell: bash

    - name: Get tensorleap infra chart version
      id: get_tensorleap_infra_chart_version
      run: |
        INFRA_CHART_VERSION=$(cat charts/tensorleap-infra/Chart.yaml | grep -E '^version:' | awk '{print $2}')
        echo "version=$INFRA_CHART_VERSION" >> $GITHUB_OUTPUT
      shell: bash

    - name: Set manifest version
      id: set_manifest_version
      run: |
        # Use prefix from determine_release_type step
        PREFIX="${{ steps.determine_release_type.outputs.prefix }}"
        # Set the manifest version to the tensorleap chart version
        if [ -n "$PREFIX" ]; then
          TAG="${PREFIX}-${{ steps.get_tensorleap_chart_version.outputs.version }}"
        else
          TAG="${{ steps.get_tensorleap_chart_version.outputs.version }}"
        fi
        echo "tag=$TAG" >> $GITHUB_OUTPUT
      shell: bash

    - name: Create installation manifest
      run: |
        echo "ğŸ“¦ Tensorleap chart version: ${{ steps.get_tensorleap_chart_version.outputs.version }}"
        echo "ğŸ“¦ Tensorleap infra chart version: ${{ steps.get_tensorleap_infra_chart_version.outputs.version }}"
        echo "ğŸ·ï¸  Release tag: ${{ steps.set_manifest_version.outputs.tag }}"
        go run . create-manifest --tensorleap-chart-version ${{ steps.get_tensorleap_chart_version.outputs.version }} --tensorleap-infra-chart-version ${{ steps.get_tensorleap_infra_chart_version.outputs.version }} --tag ${{ steps.set_manifest_version.outputs.tag }} --output manifest.yaml
      shell: bash

    - name: Print charts versions
      run: |
        echo "Tensorleap chart version: ${{ steps.get_tensorleap_chart_version.outputs.version }}"
        echo "Tensorleap infra chart version: ${{ steps.get_tensorleap_infra_chart_version.outputs.version }}"
      shell: bash

    - name: Print manifest
      run: cat manifest.yaml
      shell: bash

    - name: Create GitHub release
      uses: ncipollo/release-action@v1
      with:
        artifacts: manifest.yaml
        tag: "${{ steps.set_manifest_version.outputs.tag }}"
        skipIfReleaseExists: true
        generateReleaseNotes: true
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
