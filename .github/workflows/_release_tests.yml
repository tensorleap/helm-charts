name: Release Tests

on:
  workflow_call:
    inputs:
      source_branch:
        description: "Branch to checkout (from triggering workflow or caller)"
        required: false
        type: string
        default: ""
  workflow_dispatch:

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Determine checkout ref
        id: checkout_ref
        run: |
          # Use source_branch input if provided, otherwise use github.ref
          if [ -n "${{ inputs.source_branch }}" ]; then
            echo "ref=${{ inputs.source_branch }}" >> $GITHUB_OUTPUT
          else
            # Fallback to github.ref (removes refs/heads/ prefix if present)
            REF="${{ github.ref }}"
            REF=$(echo "$REF" | sed 's|^refs/heads/||')
            echo "ref=$REF" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.checkout_ref.outputs.ref }}
          fetch-depth: 0
          persist-credentials: true
          token: ${{ secrets.TENSORLEAP_OPS_GITHUB_TOKEN }}
      
      - name: Configure Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
        shell: bash

      - id: checkout_rc_branch
        name: Get Release Candidate branch
        run: |
          set -euo pipefail
          BRANCH="$(make -s checkout-rc-branch)"
          if [ -z "$BRANCH" ]; then
            echo "Error: Failed to get branch name from checkout-rc-branch" >&2
            exit 1
          fi
          echo "rc_branch=$BRANCH" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Run tests
        run: |
          set -euo pipefail
          # checkout-rc-branch already switches to the RC branch, so we're already on it
          # Run tests on the release candidate branch
          # Here we need to run the tests
        shell: bash