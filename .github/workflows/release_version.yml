name: Release Version- From RC Branch to Production

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      custom_tag_prefix:
        description: "Custom tag prefix for manifest"
        required: false
        default: ""

# Allow pushing new branches using the provided token
permissions:
  contents: write

jobs:
  # Step 1: Update Images
  update-images:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Update Images
        uses: ./.github/actions/update-images/action.yml
        with:
          github_token: ${{ secrets.TENSORLEAP_OPS_GITHUB_TOKEN }}

  # Step 2: Create Release Candidate
  release-candidate:
    needs: update-images
    uses: ./.github/workflows/release_candidate.yml
    with:
      custom_tag_prefix: ${{ inputs.custom_tag_prefix }}
    secrets: inherit

  # Step 3: Run Tests
  run-tests:
    needs: release-candidate
    uses: ./.github/workflows/_release_tests.yml
    secrets: inherit

  # Step 4: Release Production (only if tests pass)
  release-production:
    needs: run-tests
    if: success()
    uses: ./.github/workflows/release_production.yml
    with:
      custom_tag_prefix: ${{ inputs.custom_tag_prefix }}
    secrets: inherit

  # Step 5: Handle test failure - output message for manual patch
  handle-test-failure:
    needs: [release-candidate, run-tests]
    if: failure() && needs.run-tests.result == 'failure'
    runs-on: ubuntu-latest
    steps:
      - name: Tests Failed - Manual Patch Required
        run: |
          echo "::error::Tests failed! Please run the 'Patch Release' workflow manually."
          echo "After the patch workflow completes, tests will run automatically."
          echo "This process will repeat until tests pass, then production release will proceed."
          exit 1
