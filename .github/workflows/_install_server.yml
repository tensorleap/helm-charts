name: Install Server

on:
  workflow_call:
    inputs:
      tag:
        description: 'Manifest tag to install (omit or leave empty to install without tag)'
        required: false
        default: ''
        type: string

jobs:
  install-server:
    name: Install Tensorleap Server
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Install leap-cli
        run: |
          curl -s https://raw.githubusercontent.com/tensorleap/leap-cli/master/install.sh | bash
          if [ $? -ne 0 ]; then
            echo "❌ leap-cli installation failed"
            exit 1
          fi
          echo "✅ leap-cli installed successfully"
        shell: bash

      - name: Install Tensorleap server
        env:
          TAG: ${{ inputs.tag }}
        run: |
          set -e
          LOG=$(mktemp)
          echo "Starting install (output in $LOG)..."
          if [ -n "$TAG" ]; then
            leap server install -t "$TAG" --yes 2>&1 | tee "$LOG" &
          else
            leap server install --yes 2>&1 | tee "$LOG" &
          fi
          INSTALL_PID=$!
          disown
          TIMEOUT=600
          ELAPSED=0
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if grep -q "You can now access Tensorleap at" "$LOG" 2>/dev/null || grep -q "authorization-request" "$LOG" 2>/dev/null; then
              echo "✅ Server is up and auth URL is ready."
              echo "Installation reached the authorization step; workflow succeeds (user can complete auth separately)."
              cat "$LOG"
              rm -f "$LOG"
              echo "✅ installation success"
              exit 0
            fi
            if ! kill -0 $INSTALL_PID 2>/dev/null; then
              echo "Install process exited before auth URL appeared."
              wait $INSTALL_PID 2>/dev/null || true
              cat "$LOG"
              rm -f "$LOG"
              exit 1
            fi
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          echo "❌ Timeout (10 min) waiting for 'You can now access Tensorleap at' or 'authorization-request' in log."
          kill $INSTALL_PID 2>/dev/null || true
          cat "$LOG"
          rm -f "$LOG"
          exit 1
        shell: bash

      - name: Validate all pods are up
        run: |
          set -e
          echo "Waiting for all pods in namespace tensorleap to be Running or Succeeded (timeout 10 min)..."
          TIMEOUT=600
          ELAPSED=0
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if ! leap server tools kubectl get pods -n tensorleap &>/dev/null; then
              echo "Waiting for namespace/pods to appear..."
              sleep 10
              ELAPSED=$((ELAPSED + 10))
              continue
            fi
            COUNT=$(leap server tools kubectl get pods -n tensorleap --no-headers 2>/dev/null | wc -l)
            COUNT=${COUNT:-0}
            NOT_READY=$(leap server tools kubectl get pods -n tensorleap -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.status.phase}{"\n"}{end}' 2>/dev/null | awk '$2 != "Running" && $2 != "Succeeded" {print $0}' || true)
            if [ "$COUNT" -gt 0 ] && [ -z "$NOT_READY" ]; then
              echo "✅ All pods in tensorleap are up."
              leap server tools kubectl get pods -n tensorleap
              exit 0
            fi
            echo "Pods not yet ready:"
            leap server tools kubectl get pods -n tensorleap
            sleep 10
            ELAPSED=$((ELAPSED + 10))
          done
          echo "❌ Timeout: not all pods are up."
          leap server tools kubectl get pods -n tensorleap
          exit 1
        shell: bash
